<%= layout('/layouts/boilerplate', { title: 'User Dashboard - Localify ' }) %>
<style>
/* Styling for locked "Coming Soon" features */
.feature-locked {
    position: relative !important;
    border-radius: var(--bs-card-border-radius) !important;
    overflow: hidden !important;
    padding: 1.5rem !important;
}

.feature-locked .feature-content-blur {
    filter: blur(4px) !important;
    opacity: 0.5 !important;
    user-select: none !important;
    pointer-events: none !important;
}

.feature-locked .feature-overlay {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--bs-primary) !important;
    font-weight: bold !important;
    background-color: rgba(255, 255, 255, 0.6) !important;
    transition: background-color 0.2s ease-out !important;
}

/* Animation on hover */
.feature-locked:hover .feature-overlay {
    background-color: rgba(255, 255, 255, 0.8) !important;
}

.feature-locked .feature-overlay i {
    animation: float 2.5s infinite ease-in-out !important;
}
</style>

<section class="py-4">
    <div class="container">
        <div class="row align-items-center mb-4">
            <div class="col">
                <h2 class="section-title mb-1">
                    Welcome back, <%= (user && user.username) ? user.username : (currentUser && currentUser.username) ? currentUser.username : 'User' %>!
                </h2>
                <p class="text-muted mb-0">
                    Here's what's happening with your local business discoveries
                </p>
            </div>
            <div class="col-auto">
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i data-lucide="user" class="me-2"></i>
                        Account Settings
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/profile"><i data-lucide="settings" class="me-2" style="width: 16px;"></i> Profile Settings</a></li>
                        <li><a class="dropdown-item" href="/preferences"><i data-lucide="sliders" class="me-2" style="width: 16px;"></i> Preferences</a></li>
                        <li><hr class="dropdown-divider" /></li>
                        <li><a class="dropdown-item" href="/logout"><i data-lucide="log-out" class="me-2" style="width: 16px;"></i> Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i data-lucide="heart" class="text-danger mb-3" style="width: 32px; height: 32px;"></i>
                        <h3 class="fw-bold text-danger"><%= favUser && favUser.favorites ? favUser.favorites.length : 0 %></h3>
                        <p class="text-muted mb-0">Favorite Businesses</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center">
                        <i data-lucide="message-square" class="text-primary mb-3" style="width: 32px; height: 32px;"></i>
                        <h3 class="fw-bold text-primary"><%=Reviewcount%></h3>
                        <p class="text-muted mb-0">Reviews Written</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center feature-locked p-0">
                        <div class="feature-content-blur">
                            <i data-lucide="clock" class="text-warning mb-3" style="width: 32px; height: 32px;"></i>
                            <h3 class="fw-bold text-warning">23</h3>
                            <p class="text-muted mb-0">Recent Searches</p>
                        </div>
                        <div class="feature-overlay">
                            <i data-lucide="lock" class="mb-1"></i>
                            <small>Coming Soon</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center feature-locked p-0">
                        <div class="feature-content-blur">
                            <i data-lucide="map-pin" class="text-success mb-3" style="width: 32px; height: 32px;"></i>
                            <h3 class="fw-bold text-success">5</h3>
                            <p class="text-muted mb-0">Areas Explored</p>
                        </div>
                        <div class="feature-overlay">
                            <i data-lucide="lock" class="mb-1"></i>
                            <small>Coming Soon</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-bold"><i data-lucide="heart" class="me-2 text-danger"></i> Favorite Businesses</h5>
                            <a href="/favorites" class="btn btn-outline-primary btn-sm">View All</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <% if (favUser && favUser.favorites && favUser.favorites.length > 0) { %>
                        <div class="row g-3">
                            <% favUser.favorites.slice(0, 4).forEach(business => { %>
                            <div class="col-md-6">
                                <div class="card border-0 bg-light h-100">
                                    <div class="row g-0">
                                        <div class="col-4">
                                            <img src="<%= (business.Image && business.Image.url) ? business.Image.url : 'https://via.placeholder.com/200x150?text=No+Image' %>" class="img-fluid rounded-start h-100 w-100" alt="<%= business.Name %>" style="object-fit: cover" />
                                        </div>
                                        <div class="col-8">
                                            <div class="card-body p-3">
                                                <h6 class="card-title mb-1"><%= business.Name %></h6>
                                                <p class="text-muted small mb-1"><i data-lucide="tag" class="me-1" style="width: 12px;"></i> <%= business.Category %></p>
                                                <form action="/favorites/remove/<%= business._id %>" method="POST">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm w-100 mt-2"><i data-lucide="heart-off" class="me-1"></i> Remove</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <% }) %>
                        </div>
                        <% } else { %>
                        <p class="text-muted text-center py-3">You haven't saved any businesses yet.</p>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 py-3">
                        <h6 class="mb-0 fw-bold"><i data-lucide="message-square" class="me-2 text-info"></i> Recent Reviews</h6>
                    </div>
                    <div class="card-body">
                        <% if (UserReview && UserReview.length > 0) { %>
                            <% UserReview.forEach(review => { %>
                                <div class="mb-3 pb-3 border-bottom">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="mb-0 small"><%= review.business ? review.business.Name : '[Business Unavailable]' %></h6>
                                        <div>
                                            <% for(let i = 1; i <= 5; i++) { %><i data-lucide="star" class="<%= i <= review.rating ? 'text-warning' : 'text-muted' %>" style="width: 12px; fill: <%= i <= review.rating ? 'currentColor' : 'none' %>;"></i><% } %>
                                        </div>
                                    </div>
                                    <p class="small text-muted mb-1">"<%= review.comment.substring(0, 50) %>..."</p>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <p class="text-muted text-center">You haven't written any reviews yet.</p>
                        <% } %>
                        <a href="/my-reviews" class="btn btn-outline-primary btn-sm w-100">View All Reviews</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>